<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GitOps Tech Arena v:2</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    
    <style>
        body { background-color: #0f172a; color: #e2e8f0; }
        .card { background: rgba(55, 161, 76, 0.7); backdrop-filter: blur(10px); border: 1px solid rgba(255,255,255,0.1); }
        .btn-vote { transition: all 0.1s; }
        .btn-vote:active { transform: scale(0.90); }
        .vote-count { transition: all 0.3s ease-out; }
    </style>
</head>
<body>
    <div id="app" class="min-h-screen flex flex-col items-center justify-center p-4">
        
        <div class="text-center mb-10">
            <h1 class="text-5xl font-bold text-transparent bg-clip-text bg-gradient-to-r from-cyan-400 to-blue-600 mb-2">
                <i class="fa-solid fa-server"></i> TechStack Arena
            </h1>
            <p class="text-slate-400">GitOps & Service Mesh Demo Environment</p>
            <div class="mt-2 inline-block px-3 py-1 rounded-full bg-blue-900 text-blue-200 text-xs font-mono">
                APP VERSION: <span class="font-bold text-white">v1.0 (Blue)</span>
            </div>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-8 w-full max-w-5xl">
            <div class="card rounded-2xl p-6 shadow-2xl">
                <h2 class="text-2xl font-semibold mb-6 border-b border-slate-700 pb-2">
                    <i class="fa-solid fa-check-to-slot text-cyan-400"></i> Oyunuzu Kullanın
                </h2>
                <div class="space-y-4">
                    <div v-for="(count, tech) in votes" :key="tech" 
                         class="flex items-center justify-between p-4 rounded-xl bg-slate-800 hover:bg-slate-750 transition border border-slate-700">
                        <div class="flex items-center gap-4">
                            <div class="w-12 h-12 rounded-lg flex items-center justify-center bg-slate-700 text-2xl shadow-inner">
                                <i v-if="tech==='Kubernetes'" class="fa-solid fa-dharmachakra text-blue-500"></i>
                                <i v-if="tech==='Docker'" class="fa-brands fa-docker text-blue-400"></i>
                                <i v-if="tech==='Terraform'" class="fa-solid fa-code text-purple-400"></i>
                                <i v-if="tech==='Ansible'" class="fa-solid fa-robot text-red-400"></i>
                            </div>
                            <div class="flex flex-col">
                                <span class="font-bold text-lg tracking-wide">{{ tech }}</span>
                                <span class="text-xs text-slate-500">Infrastructure</span>
                            </div>
                        </div>
                        <div class="flex items-center gap-6">
                            <div class="text-right">
                                <div class="vote-count text-2xl font-mono font-bold text-cyan-300">
                                    {{ count }}
                                </div>
                                <div class="text-[10px] text-slate-500 uppercase tracking-wider">Votes</div>
                            </div>
                            <button @click="castVote(tech)" 
                                    class="btn-vote px-5 py-2 bg-gradient-to-r from-blue-600 to-cyan-600 hover:from-blue-500 hover:to-cyan-500 rounded-lg font-bold text-white shadow-lg shadow-cyan-500/20 flex items-center gap-2">
                                <i class="fa-solid fa-plus text-sm"></i> OY
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <div class="card rounded-2xl p-6 shadow-2xl flex flex-col justify-between">
                <div>
                    <h2 class="text-2xl font-semibold mb-6 border-b border-slate-700 pb-2 flex justify-between items-center">
                        <span><i class="fa-solid fa-chart-pie text-purple-400"></i> Canlı Sonuçlar</span>
                        <button @click="resetVotes" class="text-xs bg-red-900/50 hover:bg-red-700 text-red-200 px-3 py-1 rounded border border-red-800 transition">
                            <i class="fa-solid fa-trash-can"></i> SIFIRLA
                        </button>
                    </h2>
                    <div class="relative h-64 w-full">
                        <canvas id="voteChart"></canvas>
                    </div>
                </div>
                <div class="mt-6 flex justify-between items-center text-sm text-slate-500 bg-slate-800/50 p-3 rounded-lg border border-slate-700/50">
                    <div><i class="fa-solid fa-bolt text-yellow-400 mr-2"></i>Polling: <strong>800ms</strong></div>
                    <div><i class="fa-solid fa-database text-green-400 mr-2"></i>Redis</div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const { createApp } = Vue

        createApp({
            data() {
                return {
                    votes: { "Kubernetes": 0, "Docker": 0, "Terraform": 0, "Ansible": 0 },
                    // KRİTİK DEĞİŞİKLİK: 'chart' değişkenini buradan sildim!
                    // Vue artık chart objesini takip etmeyecek ve bozmayacak.
                    apiBase: '/api',
                    polling: null
                }
            },
            created() {
                // Chart instance'ını burada, Vue'nun gözünden uzak bir yerde tutuyoruz.
                this.chartInstance = null;
            },
            methods: {
                async fetchVotes() {
                    try {
                        const res = await fetch(`${this.apiBase}/votes`);
                        if (!res.ok) return;
                        const data = await res.json();
                        
                        // Veri değişti mi kontrolü yapmaya gerek yok, Chart.js halleder
                        if (data) {
                            this.votes = data;
                            this.updateChart();
                        }
                    } catch (e) { console.error(e); }
                },
                async castVote(tech) {
                    try {
                        // Optimistic Update
                        if(this.votes[tech] !== undefined) this.votes[tech]++;
                        this.updateChart();
                        await fetch(`${this.apiBase}/vote/${tech}`, { method: 'POST' });
                    } catch (e) { console.error(e); }
                },
                async resetVotes() {
                    if(!confirm("Emin misin?")) return;
                    try {
                        clearInterval(this.polling); // Durdur
                        const res = await fetch(`${this.apiBase}/votes`, { method: 'DELETE' });
                        if (res.ok) {
                            Object.keys(this.votes).forEach(k => this.votes[k] = 0);
                            
                            // Grafiği komple temizle
                            if(this.chartInstance) {
                                this.chartInstance.destroy();
                                this.chartInstance = null;
                            }
                            this.initChart();
                        }
                    } catch (e) { console.error(e); } 
                    finally { this.polling = setInterval(this.fetchVotes, 800); } // Başlat
                },
                initChart() {
                    const ctx = document.getElementById('voteChart').getContext('2d');
                    // Eski varsa sil
                    if(this.chartInstance) this.chartInstance.destroy();

                    // 'this.chartInstance' kullanıyoruz (data içinde tanımlı değil)
                    this.chartInstance = new Chart(ctx, {
                        type: 'doughnut',
                        data: {
                            labels: Object.keys(this.votes),
                            datasets: [{
                                data: Object.values(this.votes),
                                backgroundColor: ['#3b82f6', '#06b6d4', '#a855f7', '#f43f5e'],
                                borderWidth: 0,
                                hoverOffset: 10
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: { legend: { position: 'bottom', labels: { color: '#cbd5e1', padding: 20 } } },
                            animation: { duration: 400 }
                        }
                    });
                },
                updateChart() {
                    if (this.chartInstance) {
                        // Basit ve güvenli güncelleme
                        this.chartInstance.data.datasets[0].data = Object.values(this.votes);
                        this.chartInstance.update();
                    }
                }
            },
            mounted() {
                this.initChart();
                this.fetchVotes();
                this.polling = setInterval(this.fetchVotes, 800);
            },
            beforeUnmount() {
                clearInterval(this.polling);
            }
        }).mount('#app')
    </script>
</body>
</html>